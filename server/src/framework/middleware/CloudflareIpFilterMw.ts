import { IpFilter } from 'express-ipfilter'
import { getProxyIp } from '../router/ExpressUtils'

// Visit: https://www.cloudflare.com/ips/
const CLOUDFLARE_IPS = [
    // IPv4
    [ '173.245.48.0', '173.245.63.255' ], // '173.245.48.0/20'
    [ '103.21.244.0', '103.21.247.255' ], // '103.21.244.0/22',
    [ '103.22.200.0', '103.22.203.255' ], // '103.22.200.0/22',
    [ '103.31.4.0', '103.31.7.255' ], // '103.31.4.0/22',
    [ '141.101.64.0', '141.101.127.255' ], // '141.101.64.0/18',
    [ '108.162.192.0', '108.162.255.255' ], // '108.162.192.0/18',
    [ '190.93.240.0', '190.93.255.255' ], // '190.93.240.0/20',
    [ '188.114.96.0', '188.114.111.255' ], // '188.114.96.0/20',
    [ '197.234.240.0', '197.234.243.255' ], // '197.234.240.0/22',
    [ '198.41.128.0', '198.41.255.255' ], // '198.41.128.0/17',
    [ '162.158.0.0', '162.159.255.255' ], // '162.158.0.0/15'
    [ '104.16.0.0', '104.23.255.255' ], // '104.16.0.0/13',
    [ '104.24.0.0', '104.27.255.255' ], // '104.24.0.0/14',
    [ '172.64.0.0', '172.71.255.255' ], // '172.64.0.0/13'
    [ '131.0.72.0', '131.0.75.255' ], // '131.0.72.0/22',
    // IPv6
    '2400:cb00::/32',
    '2606:4700::/32',
    '2803:f800::/32',
    '2405:b500::/32',
    '2405:8100::/32',
    '2a06:98c0::/29',
    '2c0f:f248::/32',
]

export const cloudflareIpFilterMw = IpFilter([...CLOUDFLARE_IPS], {
    mode: 'allow',
    log: false,
    detectIp: getProxyIp,
})
